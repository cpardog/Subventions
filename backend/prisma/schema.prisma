// ===========================================
// Sistema de Gestión de Subvenciones
// Schema Prisma - PostgreSQL
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// ENUMS
// ===========================================

enum Rol {
  BENEFICIARIO
  ARRENDADOR
  DIGER
  DIRECTORA
  ORDENADOR_GASTO
  CRI
}

enum EstadoUsuario {
  ACTIVO
  INACTIVO
  BLOQUEADO
}

enum EstadoProceso {
  BORRADOR
  ENVIADA
  DOCUMENTOS_EN_VALIDACION
  REQUIERE_CORRECCION
  VALIDADA_DIGER
  REVISION_DIRECTORA
  REVISION_ORDENADOR
  FIRMADA
  FINALIZADA
  RECHAZADA
}

enum TipoDocumento {
  CEDULA_IDENTIDAD
  CONTRATO_ARRENDAMIENTO
  CERTIFICADO_RESIDENCIA
  RECIBO_SERVICIO
  CERTIFICADO_INGRESOS
  DECLARACION_JURADA
  OTRO
}

enum EstadoDocumento {
  PENDIENTE
  APROBADO
  RECHAZADO
}

enum TipoEvento {
  CREACION
  EDICION
  ENVIO
  VALIDACION
  APROBACION
  RECHAZO
  CORRECCION_SOLICITADA
  CORRECCION_ENVIADA
  FIRMA
  CIERRE
  CAMBIO_ESTADO
}

// ===========================================
// USUARIOS Y AUTENTICACIÓN
// ===========================================

model Usuario {
  id                    String         @id @default(uuid())
  cedula                String         @unique
  email                 String         @unique
  nombreCompleto        String         @map("nombre_completo")
  passwordHash          String         @map("password_hash")
  rol                   Rol
  estado                EstadoUsuario  @default(ACTIVO)
  
  // MFA
  mfaSecret             String?        @map("mfa_secret")
  mfaHabilitado         Boolean        @default(false) @map("mfa_habilitado")
  
  // Seguridad
  intentosFallidos      Int            @default(0) @map("intentos_fallidos")
  bloqueadoHasta        DateTime?      @map("bloqueado_hasta")
  ultimoAcceso          DateTime?      @map("ultimo_acceso")
  
  // Timestamps
  creadoEn              DateTime       @default(now()) @map("creado_en")
  actualizadoEn         DateTime       @updatedAt @map("actualizado_en")
  creadoPorId           String?        @map("creado_por_id")
  
  // Relaciones
  creadoPor             Usuario?       @relation("UsuarioCreador", fields: [creadoPorId], references: [id])
  usuariosCreados       Usuario[]      @relation("UsuarioCreador")
  passwordHistorial     PasswordHistorial[]
  sesiones              Sesion[]
  procesosBeneficiario  Proceso[]      @relation("BeneficiarioProceso")
  procesosArrendador    Proceso[]      @relation("ArrendadorProceso")
  documentosCargados    Documento[]    @relation("DocumentoCargado")
  documentosValidados   Documento[]    @relation("DocumentoValidado")
  eventosAuditoria      EventoAuditoria[]
  decisiones            Decision[]
  tokenRecuperacion     TokenRecuperacion[]
  cambiosRol            CambioRol[]

  @@index([email])
  @@index([cedula])
  @@index([rol])
  @@index([estado])
  @@map("usuarios")
}

model PasswordHistorial {
  id          String   @id @default(uuid())
  usuarioId   String   @map("usuario_id")
  passwordHash String  @map("password_hash")
  creadoEn    DateTime @default(now()) @map("creado_en")
  
  usuario     Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@index([usuarioId])
  @@map("password_historial")
}

model TokenRecuperacion {
  id          String   @id @default(uuid())
  usuarioId   String   @map("usuario_id")
  token       String   @unique
  expiraEn    DateTime @map("expira_en")
  usado       Boolean  @default(false)
  creadoEn    DateTime @default(now()) @map("creado_en")
  
  usuario     Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@index([token])
  @@index([usuarioId])
  @@map("tokens_recuperacion")
}

model Sesion {
  id            String   @id @default(uuid())
  usuarioId     String   @map("usuario_id")
  tokenHash     String   @unique @map("token_hash")
  ipAddress     String   @map("ip_address")
  userAgent     String   @map("user_agent")
  expiraEn      DateTime @map("expira_en")
  creadoEn      DateTime @default(now()) @map("creado_en")
  ultimaActividad DateTime @default(now()) @map("ultima_actividad")
  
  usuario       Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@index([usuarioId])
  @@index([tokenHash])
  @@map("sesiones")
}

model CambioRol {
  id            String   @id @default(uuid())
  usuarioId     String   @map("usuario_id")
  rolAnterior   Rol      @map("rol_anterior")
  rolNuevo      Rol      @map("rol_nuevo")
  motivo        String?
  cambiadoPorId String   @map("cambiado_por_id")
  creadoEn      DateTime @default(now()) @map("creado_en")
  
  usuario       Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@index([usuarioId])
  @@map("cambios_rol")
}

// ===========================================
// CATÁLOGO DE DOCUMENTOS
// ===========================================

model CatalogoDocumento {
  id              String        @id @default(uuid())
  tipo            TipoDocumento @unique
  nombre          String
  descripcion     String?
  obligatorio     Boolean       @default(true)
  formatosPermitidos String[]   @map("formatos_permitidos")
  tamanoMaximoMb  Int           @default(10) @map("tamano_maximo_mb")
  vigenciaDias    Int?          @map("vigencia_dias")
  activo          Boolean       @default(true)
  orden           Int           @default(0)
  creadoEn        DateTime      @default(now()) @map("creado_en")
  actualizadoEn   DateTime      @updatedAt @map("actualizado_en")
  
  documentos      Documento[]
  
  @@map("catalogo_documentos")
}

// ===========================================
// PROCESOS DE SUBVENCIÓN
// ===========================================

model Proceso {
  id                  String        @id @default(uuid())
  codigo              String        @unique
  
  // Datos del proceso
  beneficiarioId      String        @map("beneficiario_id")
  arrendadorId        String?       @map("arrendador_id")
  estado              EstadoProceso @default(BORRADOR)
  
  // Datos del formulario
  formulario          Json?
  
  // PDF
  pdfPath             String?       @map("pdf_path")
  pdfHash             String?       @map("pdf_hash")
  pdfVersion          Int           @default(0) @map("pdf_version")
  
  // Firma
  firmado             Boolean       @default(false)
  firmadoEn           DateTime?     @map("firmado_en")
  firmadoPorId        String?       @map("firmado_por_id")
  firmaHash           String?       @map("firma_hash")
  firmaIp             String?       @map("firma_ip")
  firmaUserAgent      String?       @map("firma_user_agent")
  
  // Cierre
  cerradoEn           DateTime?     @map("cerrado_en")
  cerradoPorId        String?       @map("cerrado_por_id")
  
  // Timestamps
  creadoEn            DateTime      @default(now()) @map("creado_en")
  actualizadoEn       DateTime      @updatedAt @map("actualizado_en")
  enviadoEn           DateTime?     @map("enviado_en")
  
  // Relaciones
  beneficiario        Usuario       @relation("BeneficiarioProceso", fields: [beneficiarioId], references: [id])
  arrendador          Usuario?      @relation("ArrendadorProceso", fields: [arrendadorId], references: [id])
  documentos          Documento[]
  eventos             EventoAuditoria[]
  decisiones          Decision[]
  historialPdf        HistorialPdf[]
  
  @@index([codigo])
  @@index([beneficiarioId])
  @@index([estado])
  @@index([creadoEn])
  @@map("procesos")
}

model Documento {
  id              String          @id @default(uuid())
  procesoId       String          @map("proceso_id")
  catalogoId      String          @map("catalogo_id")
  
  // Archivo
  nombreOriginal  String          @map("nombre_original")
  nombreAlmacenado String         @map("nombre_almacenado")
  rutaArchivo     String          @map("ruta_archivo")
  mimeType        String          @map("mime_type")
  tamanoBytes     Int             @map("tamano_bytes")
  hashArchivo     String          @map("hash_archivo")
  
  // Validación
  estado          EstadoDocumento @default(PENDIENTE)
  validadoPorId   String?         @map("validado_por_id")
  validadoEn      DateTime?       @map("validado_en")
  motivoRechazo   String?         @map("motivo_rechazo")
  
  // Versionamiento
  version         Int             @default(1)
  esActivo        Boolean         @default(true) @map("es_activo")
  
  // Timestamps
  creadoEn        DateTime        @default(now()) @map("creado_en")
  cargadoPorId    String          @map("cargado_por_id")
  
  // Relaciones
  proceso         Proceso         @relation(fields: [procesoId], references: [id], onDelete: Cascade)
  catalogo        CatalogoDocumento @relation(fields: [catalogoId], references: [id])
  cargadoPor      Usuario         @relation("DocumentoCargado", fields: [cargadoPorId], references: [id])
  validadoPor     Usuario?        @relation("DocumentoValidado", fields: [validadoPorId], references: [id])
  descargas       RegistroDescarga[]
  
  @@index([procesoId])
  @@index([catalogoId])
  @@index([estado])
  @@map("documentos")
}

model RegistroDescarga {
  id          String   @id @default(uuid())
  documentoId String   @map("documento_id")
  usuarioId   String   @map("usuario_id")
  ipAddress   String   @map("ip_address")
  userAgent   String   @map("user_agent")
  creadoEn    DateTime @default(now()) @map("creado_en")
  
  documento   Documento @relation(fields: [documentoId], references: [id], onDelete: Cascade)
  
  @@index([documentoId])
  @@index([usuarioId])
  @@map("registro_descargas")
}

model HistorialPdf {
  id          String   @id @default(uuid())
  procesoId   String   @map("proceso_id")
  version     Int
  pdfPath     String   @map("pdf_path")
  pdfHash     String   @map("pdf_hash")
  creadoEn    DateTime @default(now()) @map("creado_en")
  
  proceso     Proceso  @relation(fields: [procesoId], references: [id], onDelete: Cascade)
  
  @@index([procesoId])
  @@map("historial_pdf")
}

// ===========================================
// DECISIONES Y APROBACIONES
// ===========================================

model Decision {
  id              String        @id @default(uuid())
  procesoId       String        @map("proceso_id")
  
  // Decisión
  estadoAnterior  EstadoProceso @map("estado_anterior")
  estadoNuevo     EstadoProceso @map("estado_nuevo")
  aprobado        Boolean
  motivo          String
  
  // Auditoría
  usuarioId       String        @map("usuario_id")
  rol             Rol
  ipAddress       String        @map("ip_address")
  userAgent       String        @map("user_agent")
  
  // Timestamp
  creadoEn        DateTime      @default(now()) @map("creado_en")
  
  // Relaciones
  proceso         Proceso       @relation(fields: [procesoId], references: [id], onDelete: Cascade)
  usuario         Usuario       @relation(fields: [usuarioId], references: [id])
  
  @@index([procesoId])
  @@index([usuarioId])
  @@index([creadoEn])
  @@map("decisiones")
}

// ===========================================
// AUDITORÍA
// ===========================================

model EventoAuditoria {
  id          String      @id @default(uuid())
  procesoId   String?     @map("proceso_id")
  usuarioId   String?     @map("usuario_id")
  
  // Evento
  tipo        TipoEvento
  descripcion String
  detalles    Json?
  
  // Contexto
  ipAddress   String      @map("ip_address")
  userAgent   String      @map("user_agent")
  
  // Timestamp (inmutable)
  creadoEn    DateTime    @default(now()) @map("creado_en")
  
  // Relaciones
  proceso     Proceso?    @relation(fields: [procesoId], references: [id], onDelete: SetNull)
  usuario     Usuario?    @relation(fields: [usuarioId], references: [id], onDelete: SetNull)
  
  @@index([procesoId])
  @@index([usuarioId])
  @@index([tipo])
  @@index([creadoEn])
  @@map("eventos_auditoria")
}

// ===========================================
// CONFIGURACIÓN DEL SISTEMA
// ===========================================

model Configuracion {
  id          String   @id @default(uuid())
  clave       String   @unique
  valor       String
  descripcion String?
  creadoEn    DateTime @default(now()) @map("creado_en")
  actualizadoEn DateTime @updatedAt @map("actualizado_en")
  
  @@map("configuracion")
}

model Convocatoria {
  id              String    @id @default(uuid())
  nombre          String
  descripcion     String?
  fechaInicio     DateTime  @map("fecha_inicio")
  fechaFin        DateTime  @map("fecha_fin")
  activa          Boolean   @default(true)
  formularioJson  Json?     @map("formulario_json")
  creadoEn        DateTime  @default(now()) @map("creado_en")
  actualizadoEn   DateTime  @updatedAt @map("actualizado_en")
  
  @@map("convocatorias")
}
